# Compile Commands Integration Example

This example demonstrates how to use the compile_commands.json integration feature in the C++ Analyzer.

## Project Structure

```
compile_commands_example/
├── CMakeLists.txt
├── compile_commands.json
├── cpp-analyzer-config.json
├── include/
│   └── utils.h
├── src/
│   ├── main.cpp
│   └── utils.cpp
└── README.md
```

## Setup

1. Create the project structure as shown above
2. Generate compile commands using CMake
3. Configure the analyzer
4. Run the analyzer

## CMakeLists.txt

```cmake
cmake_minimum_required(VERSION 3.16)
project(CompileCommandsExample CXX)

# Enable compile commands generation
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Add executable
add_executable(example src/main.cpp src/utils.cpp)

# Include directories
target_include_directories(example PRIVATE include)

# Compiler flags
target_compile_features(example PRIVATE cxx_std_17)
target_compile_options(example PRIVATE -Wall -Wextra)
```

## Source Files

### include/utils.h

```cpp
#pragma once
#include <string>

std::string get_greeting();
int calculate_sum(int a, int b);
```

### src/utils.cpp

```cpp
#include "utils.h"
#include <string>

std::string get_greeting() {
    return "Hello from CompileCommands Example!";
}

int calculate_sum(int a, int b) {
    return a + b;
}
```

### src/main.cpp

```cpp
#include "utils.h"
#include <iostream>

int main() {
    std::cout << get_greeting() << std::endl;
    
    int result = calculate_sum(5, 3);
    std::cout << "5 + 3 = " << result << std::endl;
    
    return 0;
}
```

## Compile Commands

The `compile_commands.json` file is automatically generated by CMake:

```json
[
  {
    "file": "src/main.cpp",
    "directory": "/path/to/compile_commands_example",
    "arguments": [
      "-std=c++17",
      "-I/path/to/compile_commands_example/include",
      "-Wall",
      "-Wextra",
      "-o",
      "CMakeFiles/example.dir/src/main.cpp.o",
      "-c",
      "/path/to/compile_commands_example/src/main.cpp"
    ],
    "command": "clang++ -std=c++17 -I/path/to/compile_commands_example/include -Wall -Wextra -o CMakeFiles/example.dir/src/main.cpp.o -c /path/to/compile_commands_example/src/main.cpp"
  },
  {
    "file": "src/utils.cpp",
    "directory": "/path/to/compile_commands_example",
    "arguments": [
      "-std=c++17",
      "-I/path/to/compile_commands_example/include",
      "-Wall",
      "-Wextra",
      "-o",
      "CMakeFiles/example.dir/src/utils.cpp.o",
      "-c",
      "/path/to/compile_commands_example/src/utils.cpp"
    ],
    "command": "clang++ -std=c++17 -I/path/to/compile_commands_example/include -Wall -Wextra -o CMakeFiles/example.dir/src/utils.cpp.o -c /path/to/compile_commands_example/src/utils.cpp"
  }
]
```

## Analyzer Configuration

### cpp-analyzer-config.json

```json
{
  "exclude_directories": [
    ".git",
    "CMakeFiles",
    "cmake-build-*",
    "__pycache__"
  ],
  "exclude_patterns": [
    "*.generated.h",
    "*.generated.cpp"
  ],
  "dependency_directories": [
    "third_party",
    "external"
  ],
  "include_dependencies": true,
  "max_file_size_mb": 10,
  "compile_commands": {
    "enabled": true,
    "path": "compile_commands.json",
    "cache_enabled": true,
    "fallback_to_hardcoded": true,
    "cache_expiry_seconds": 300,
    "supported_extensions": [".cpp", ".cc", ".cxx", ".c++", ".h", ".hpp", ".hxx", ".h++"],
    "exclude_patterns": [
      "*/CMakeFiles/*",
      "*/cmake-build-*",
      "*/build/*"
    ]
  }
}
```

## Usage

### 1. Build the Project

```bash
mkdir build
cd build
cmake ..
make
```

### 2. Run the Analyzer

```bash
# Set the project directory
python -m mcp.server.cpp_mcp_server set_project_directory /path/to/compile_commands_example

# Get server status (should show compile commands enabled)
python -m mcp.server.cpp_mcp_server get_server_status

# Search for functions
python -m mcp.server.cpp_mcp_server search_functions ".*"

# Get specific function info
python -m mcp.server.cpp_mcp_server get_function_signature "get_greeting"

# Find function calls
python -m mcp.server.cpp_mcp_server find_callees "main"
```

### 3. Expected Results

The analyzer should be able to:

- Find all functions: `main`, `get_greeting`, `calculate_sum`
- Parse include statements correctly
- Use the proper include paths from compile commands
- Handle C++17 features
- Provide accurate symbol information

## Benefits of Compile Commands

### 1. Accurate Include Paths

The analyzer uses the same include paths as the compiler:

```cpp
#include "utils.h"  // Found using -I/path/to/compile_commands_example/include
```

### 2. Correct Compiler Flags

Uses the same compiler flags as the build:

```cpp
// Uses -std=c++17, -Wall, -Wextra from compile commands
```

### 3. Platform-Specific Paths

Handles platform-specific include paths correctly:

```cpp
// Windows: -IC:/Program Files/SomeSDK/include
// Linux:   -I/usr/include/something
// macOS:   -I/opt/local/include
```

### 4. Project-Specific Configuration

Respects project-specific compiler configurations:

```cpp
// Custom defines from compile commands
#define CUSTOM_DEFINE 1
```

## Troubleshooting

### Common Issues

1. **Compile commands not found**
   - Ensure `compile_commands.json` exists in the project root
   - Check that CMAKE_EXPORT_COMPILE_COMMANDS is ON
   - Verify the file path in configuration

2. **Missing symbols**
   - Check that include paths are correct in compile commands
   - Verify that header files are included in compile commands
   - Ensure fallback arguments are enabled

3. **Performance issues**
   - Enable caching in configuration
   - Adjust cache expiry time
   - Check for large compile commands files

### Debug Commands

```bash
# Check compile commands status
python -m mcp.server.cpp_mcp_server get_server_status

# Refresh project (if compile commands changed)
python -m mcp.server.cpp_mcp_server refresh_project

# Test with a specific file
python -m mcp.server.cpp_mcp_server find_in_file "src/main.cpp" "main"
```

## Advanced Configuration

### Custom Compile Commands Path

If your compile commands are in a different location:

```json
{
  "compile_commands": {
    "enabled": true,
    "path": "build/compile_commands.json",
    "cache_enabled": true,
    "fallback_to_hardcoded": true
  }
}
```

### Disabled Compile Commands

To disable compile commands and use fallback arguments:

```json
{
  "compile_commands": {
    "enabled": false,
    "fallback_to_hardcoded": true
  }
}
```

### Custom File Extensions

To support additional file types:

```json
{
  "compile_commands": {
    "supported_extensions": [".cpp", ".cc", ".cxx", ".c++", ".h", ".hpp", ".hxx", ".h++", ".inl"]
  }
}
```

## Related Files

- [COMPILE_COMMANDS_INTEGRATION.md](../../COMPILE_COMMANDS_INTEGRATION.md) - Detailed documentation
- [../../cpp-analyzer-config.json](../../cpp-analyzer-config.json) - Default configuration
- [../../mcp_server/compile_commands_manager.py](../../mcp_server/compile_commands_manager.py) - Implementation